# EC2 using Terraform and Ansible in pull mode

Creation of EC2 instance using terraform, setup and installing nodejs App using ansible in push mode
Security group used needs to have 22 port open for enable ansible ssh connection


Using ~/.aws/credentials file
If not created, create using "aws configure"

Project structure,
- helloworld-ec2.tf  Terraform file, using Terrafor Provisiones for setup instance
- .gitignore         For avoid upload security information to github repo
- helloworld.yml     Ansible playbook, 
- library, roles     Ansible roles, hosts pointing to all
  - roles/nodejs/tasks/main.yml 
                     Installation of nodejs and npm
                     Also used for install required depedencies for npm "date-and-time"

```js
- name: Install node.js packages globally.
  npm:
    name: date-and-time
    registry: 'http://registry.npmjs.org/'
    path: /home/ec2-user
```

                     name: packages to install, if more than one use array notaion,  ['one','another']
                     registry: location from where is going to get packages
                     path: location where to install packages locally
- ansible.cfg        Ansible configuration, inventory pointing to ./myinventory, file generated by Terraform Provisioner local-exec command
- terraform.tfstate  Automatically created, keeps infra creation state

```js
%> terraform init
%> terraform validate
%> terraform plan -out t1.plan
%> terraform apply t1.plan
aws_instance.myserver: Creating...
...
aws_instance.myserver: Provisioning with 'remote-exec'...
...
aws_instance.myserver (remote-exec): Connected!
aws_instance.myserver (remote-exec): Logging from EC2 instance
aws_instance.myserver: Provisioning with 'local-exec'...
aws_instance.myserver (local-exec): Executing: ["/bin/sh" "-c" "echo '54.210.200.199' > ./myinventory"]
aws_instance.myserver: Provisioning with 'local-exec'...
aws_instance.myserver (local-exec): Executing: ["/bin/sh" "-c" "ansible-playbook -i myinventory --private-key ~/.ssh/EffectiveDevOpsAWS.pem helloworld.yml"]
aws_instance.myserver: Still creating... [1m10s elapsed]

aws_instance.myserver (local-exec): PLAY [all] *********************************************************************

aws_instance.myserver (local-exec): TASK [Gathering Facts] *********************************************************
...
aws_instance.myserver (local-exec): PLAY RECAP *********************************************************************
aws_instance.myserver (local-exec): 54.210.200.199             : ok=6    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

aws_instance.myserver: Creation complete after 1m55s [id=i-0e9494e4afd5a878f]

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.

Outputs:

myserver = "54.210.200.199"

%> curl http://54.210.200.199:3000
Hello World, 2021/08/21 19:18:09
%> terraform destroy
```

## Testing changes on NodeJS locally before deploy to EC2 instance

Steps
- Update JS file
- Install required packages for NodeJS, on automation used main.yml of nodejs
- Execute locally App
- On different terminal test app

```js
%> cat ./roles/helloworld/files/helloworld.js

var http = require("http")

http.createServer(function (request, response) {

   // Send the HTTP header
   // HTTP Status: 200 : OK
   // Content Type: text/plain
   response.writeHead(200, {'Content-Type': 'text/plain'})

   // Send the response body as "Hello World"
   var mydate = new Date();
   var dateformated = date.format(mydate,'YYYY/MM/DD HH:mm:ss');

   var msg = "Hello World, " + dateformated + "\n";
   response.end(msg)
}).listen(3000)

// Console will print the message
console.log('Server running')

%> npm install date-and-time --save
all date-and-time --save

added 1 package, and audited 2 packages in 1s

found 0 vulnerabilities

%> node ./roles/helloworld/files/helloworld.js
Server running

%> curl http://localhost:3000
Hello World, 2021/08/21 13:53:35

```